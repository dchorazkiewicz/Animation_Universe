<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Laboratorium Liczb Bartka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Blokada zaznaczania tekstu dla UI */
        body { user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        
        /* Animacje */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes spin-slow { to { transform: rotate(360deg); } }
        .spin-slow { animation: spin-slow 4s linear infinite; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }

        /* Style specyficzne dla kafelk√≥w */
        .tile-btn:active { transform: scale(0.95); }
        
        /* Custom Scrollbar hide */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center justify-center p-2 font-sans overflow-hidden relative">

    <!-- G≈Å√ìWNY KONTENER -->
    <div class="w-full max-w-2xl flex flex-col gap-2 h-[95vh] z-10">
        
        <!-- HEADER Z TYTU≈ÅEM -->
        <header class="flex items-center justify-center gap-2 mb-2 py-2">
            <div class="flex flex-col items-center">
                <h1 class="text-2xl sm:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-green-400 via-yellow-400 to-orange-400 drop-shadow-sm tracking-tight text-center leading-tight">
                    Laboratorium<br class="sm:hidden"/> Liczb Bartka
                </h1>
            </div>
        </header>

        <!-- 1. PASEK TABS & STATUS -->
        <div class="flex flex-col gap-2">
            <!-- Zak≈Çadki -->
            <div class="bg-slate-800 p-1 rounded-2xl flex shadow-lg overflow-x-auto hide-scroll">
                <button onclick="App.setMode('ADD')" id="btn-mode-add" class="flex-1 py-3 px-2 rounded-xl font-bold text-sm sm:text-lg transition-colors flex items-center justify-center gap-2 whitespace-nowrap">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Dodawanie
                </button>
                <button onclick="App.setMode('SUB')" id="btn-mode-sub" class="flex-1 py-3 px-2 rounded-xl font-bold text-sm sm:text-lg transition-colors flex items-center justify-center gap-2 whitespace-nowrap">
                    <i data-lucide="minus-circle" class="w-5 h-5"></i> Odejmowanie
                </button>
                <button onclick="App.setMode('COUNT')" id="btn-mode-count" class="flex-1 py-3 px-2 rounded-xl font-bold text-sm sm:text-lg transition-colors flex items-center justify-center gap-2 whitespace-nowrap">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Liczenie
                </button>
            </div>

            <!-- Pasek Info: Wynik | Zakres -->
            <div class="flex justify-between items-center px-2">
                <div class="flex items-center gap-3 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700">
                    <i data-lucide="star" class="w-6 h-6 text-yellow-400 fill-yellow-400"></i>
                    <span id="score-val" class="text-2xl font-bold text-white">0</span>
                </div>

                <!-- Prze≈ÇƒÖcznik Zakresu -->
                <button onclick="App.toggleRange()" class="flex items-center gap-2 bg-slate-800 px-1 py-1 pr-4 rounded-full border border-slate-700 active:scale-95 transition-transform">
                    <div id="range-indicator" class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs bg-emerald-500 text-white transition-colors">
                        10
                    </div>
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Zakres</span>
                </button>
            </div>
        </div>

        <!-- 2. SCENA GRY (CANVAS) -->
        <div class="flex-1 bg-slate-800 rounded-3xl border border-slate-700 relative overflow-hidden flex flex-col shadow-2xl">
            
            <!-- Overlay Feedback (Brawo/B≈ÇƒÖd) -->
            <div id="feedback-layer" class="absolute inset-0 z-50 hidden flex-col items-center justify-center bg-slate-900/95 backdrop-blur-sm">
                <div id="feedback-emoji" class="text-8xl mb-4 animate-pop"></div>
                <div id="feedback-text" class="text-4xl font-bold text-center px-4"></div>
            </div>

            <!-- Obszar Wizualizacji -->
            <div class="flex-1 flex flex-col p-4 justify-center">
                
                <!-- Kontener Klock√≥w -->
                <div id="visual-container" class="w-full bg-slate-900/50 rounded-2xl border border-slate-700/50 p-4 mb-4 min-h-[160px] flex items-center justify-center">
                    <!-- Dynamiczna zawarto≈õƒá -->
                </div>

                <!-- Pytanie -->
                <div class="h-16 flex items-center justify-center">
                    <h2 id="question-text" class="text-xl sm:text-3xl font-bold text-slate-300 text-center">Ile to razem?</h2>
                </div>
            </div>
        </div>

        <!-- 3. PANEL ODPOWIEDZI -->
        <div id="options-container" class="grid grid-cols-4 gap-3 h-24 sm:h-32">
            <!-- Przyciski generowane dynamicznie -->
        </div>

        <!-- Stopka: Reset -->
        <div class="flex justify-center mt-2">
            <button onclick="App.reset()" class="text-slate-500 text-sm flex items-center gap-2 hover:text-slate-300 p-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Resetuj wynik
            </button>
        </div>
    </div>

    <!-- LOGIKA APLIKACJI -->
    <script>
        /**
         * LOGIC CORE - Czysta matematyka
         */
        const MathCore = {
            // Generuje pytanie do dodawania
            generateAddition(range, currentScore) {
                let maxTarget = range;
                if (range === 10) {
                    if (currentScore < 5) maxTarget = 5;       
                    else if (currentScore < 10) maxTarget = 8; 
                    else maxTarget = 10;
                } else {
                    maxTarget = 20;
                }
                const minTarget = range === 20 ? 11 : 2;
                const target = Math.floor(Math.random() * (maxTarget - minTarget + 1)) + minTarget;
                const splitPoint = Math.floor(Math.random() * (target - 1)) + 1;
                let a = splitPoint;
                let b = target - splitPoint;

                if (b > a && Math.random() > 0.2) { [a, b] = [b, a]; }

                return { type: 'ADD', a, b, correct: target };
            },

            // Generuje pytanie do odejmowania
            generateSubtraction(range, currentScore) {
                let maxA = range;
                if (range === 10) {
                    if (currentScore < 5) maxA = 5;
                    else if (currentScore < 10) maxA = 8;
                }
                const minA = 2;
                const a = Math.floor(Math.random() * (maxA - minA + 1)) + minA;
                const maxB = a - 1;
                const b = Math.floor(Math.random() * maxB) + 1;

                return { type: 'SUB', a, b, correct: a - b };
            },

            // Generuje pytanie do liczenia
            generateCounting(range) {
                const minVal = range === 20 ? 5 : 1;
                const target = Math.floor(Math.random() * (range - minVal + 1)) + minVal;
                let layout = 'pairs'; 
                if (target <= 9 && Math.random() > 0.5) layout = 'square'; 
                if (target % 5 === 0 || (target > 10 && Math.random() > 0.6)) layout = 'fives';

                return { type: 'COUNT', value: target, layout, correct: target };
            },

            // Generuje odpowiedzi
            generateOptions(correct, maxRange) {
                const options = new Set();
                options.add(correct);
                const candidates = [correct - 1, correct + 1, correct - 2, correct + 2, correct - 3, correct + 3];
                candidates.sort(() => Math.random() - 0.5);

                for (let n of candidates) {
                    if (n > 0 && n <= (maxRange + 5) && !options.has(n)) {
                        options.add(n);
                    }
                    if (options.size === 4) break;
                }
                while (options.size < 4) {
                    let r = Math.floor(Math.random() * maxRange) + 1;
                    if (r > 0) options.add(r);
                }
                return Array.from(options).sort((a, b) => a - b);
            }
        };

        /**
         * RENDERER - Funkcje pomocnicze do HTML
         */
        const Renderer = {
            // Tworzy HTML dla pojedynczego klocka
            createBlock(color, size = "md", isCrossed = false) {
                const sizes = {
                    sm: "w-6 h-6 sm:w-8 sm:h-8",
                    md: "w-8 h-8 sm:w-10 sm:h-10",
                    lg: "w-10 h-10 sm:w-12 sm:h-12"
                };
                
                let crossHtml = '';
                if (isCrossed) {
                    // Slash wychodzƒÖcy poza obrys
                    crossHtml = `<div class="absolute w-[140%] h-1 bg-orange-500 rounded-full left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 -rotate-45 pointer-events-none shadow-sm z-10"></div>`;
                }

                return `<div class="${sizes[size]} bg-${color}-500 rounded-md border-2 border-slate-900 shadow-[0_4px_0_rgba(0,0,0,0.3)] transform transition-transform hover:scale-110 flex items-center justify-center relative overflow-visible z-0 mx-0.5">
                    ${crossHtml}
                </div>`;
            },

            // Grid zwyk≈Çy
            createGrid(count, color, layout = 'auto') {
                let gridClass = "grid-cols-2"; 
                let size = "md";
                if (count > 12) size = "sm";

                if (layout === 'fives') gridClass = "grid-cols-5";
                else if (layout === 'square') gridClass = count > 4 ? "grid-cols-3" : "grid-cols-2";
                else if (count > 8) gridClass = "grid-cols-3 sm:grid-cols-4"; 

                let html = `<div class="grid ${gridClass} gap-2 p-2 bg-slate-800/50 rounded-xl border border-slate-700/50">`;
                for (let i = 0; i < count; i++) {
                    let c = color;
                    if (layout === 'fives') {
                        if (Math.floor(i / 5) % 2 !== 0) c = color === 'blue' ? 'indigo' : 'emerald';
                    }
                    html += this.createBlock(c, size);
                }
                html += `</div>`;
                return html;
            },

            // Grid do odejmowania
            createSubtractionGrid(total, crossedCount) {
                const thresholdIndex = total - crossedCount;
                let html = '';

                if (total <= 10) {
                    // Tryb Liniowy (do 10)
                    let size = "md";
                    if (total > 6) size = "sm";

                    html += `<div class="flex flex-nowrap justify-center gap-1 sm:gap-2 p-3 bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-visible">`;
                    for (let i = 0; i < total; i++) {
                        const isCrossed = i >= thresholdIndex;
                        html += this.createBlock('blue', size, isCrossed);
                    }
                    html += `</div>`;
                } else {
                    // Tryb "Ramki Dziesiƒôtnej" (> 10)
                    let size = "sm"; 
                    html += `<div class="grid grid-cols-5 gap-x-2 gap-y-2 p-3 bg-slate-800/50 rounded-xl border border-slate-700/50 overflow-visible">`;
                    for (let i = 0; i < total; i++) {
                        const isCrossed = i >= thresholdIndex;
                        html += this.createBlock('blue', size, isCrossed);
                    }
                    html += `</div>`;
                }
                return html;
            }
        };

        /**
         * APP CONTROLLER
         */
        const App = {
            state: {
                mode: 'ADD',    // ADD | SUB | COUNT
                range: 10,
                score: 0,
                isLocked: false,
                currentQuestion: null
            },

            emojis: {
                success: ['ü§©', 'üëç', 'ü§Ø', 'üòé'],
                error: ['üò±', 'üò®', 'ü´£']
            },

            init() {
                lucide.createIcons();
                this.updateUI();
                this.nextQuestion();
            },

            setMode(mode) {
                if (this.state.isLocked) return;
                this.state.mode = mode;
                this.state.score = 0; 
                this.updateUI();
                this.nextQuestion();
            },

            toggleRange() {
                if (this.state.isLocked) return;
                this.state.range = this.state.range === 10 ? 20 : 10;
                this.state.score = 0;
                this.updateUI();
                this.nextQuestion();
            },

            reset() {
                this.state.score = 0;
                this.updateUI();
                this.nextQuestion();
            },

            nextQuestion() {
                this.state.isLocked = false;
                this.hideFeedback();

                const { mode, range, score } = this.state;
                let qData;

                if (mode === 'ADD') qData = MathCore.generateAddition(range, score);
                else if (mode === 'SUB') qData = MathCore.generateSubtraction(range, score);
                else qData = MathCore.generateCounting(range);

                const options = MathCore.generateOptions(qData.correct, range);
                this.state.currentQuestion = { ...qData, options };
                
                this.renderScene();
                this.renderOptions();
                lucide.createIcons(); 
            },

            handleAnswer(answer) {
                if (this.state.isLocked) return;
                
                const correct = this.state.currentQuestion.correct;
                this.state.isLocked = true;

                if (answer === correct) {
                    this.state.score++;
                    this.updateUI();
                    this.showFeedback(true);
                    setTimeout(() => { this.nextQuestion(); }, 800);
                } else {
                    this.showFeedback(false);
                    setTimeout(() => {
                        this.hideFeedback();
                        this.state.isLocked = false; 
                    }, 1500);
                }
            },

            // --- UI RENDERERS ---

            renderScene() {
                const q = this.state.currentQuestion;
                const container = document.getElementById('visual-container');
                const title = document.getElementById('question-text');

                container.innerHTML = ''; 

                if (q.type === 'ADD') {
                    title.innerText = "Ile to razem?";
                    container.innerHTML = `
                        <div class="flex items-center gap-2 sm:gap-4 animate-pop">
                            <div class="flex flex-col items-center">
                                <span class="text-4xl font-bold text-blue-400 mb-2">${q.a}</span>
                                ${Renderer.createGrid(q.a, 'blue')}
                            </div>
                            <div class="text-4xl font-black text-slate-500">+</div>
                            <div class="flex flex-col items-center">
                                <span class="text-4xl font-bold text-orange-400 mb-2">${q.b}</span>
                                ${Renderer.createGrid(q.b, 'orange')}
                            </div>
                        </div>
                    `;
                } else if (q.type === 'SUB') {
                    title.innerText = "Ile zosta≈Ço?";
                    container.innerHTML = `
                        <div class="flex flex-col items-center animate-pop w-full">
                             <div class="flex items-center gap-4 mb-4">
                                <span class="text-5xl font-bold text-blue-400">${q.a}</span>
                                <span class="text-5xl font-black text-slate-500">-</span>
                                <span class="text-5xl font-bold text-orange-500">${q.b}</span>
                             </div>
                            ${Renderer.createSubtractionGrid(q.a, q.b)}
                        </div>
                    `;
                } else {
                    title.innerText = "Ile klock√≥w widzisz?";
                    container.innerHTML = `
                        <div class="flex flex-col items-center animate-pop">
                            ${Renderer.createGrid(q.value, 'green', q.layout)}
                        </div>
                    `;
                }
            },

            renderOptions() {
                const container = document.getElementById('options-container');
                container.innerHTML = '';

                this.state.currentQuestion.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "tile-btn bg-slate-700 hover:bg-slate-600 border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 rounded-2xl text-3xl sm:text-4xl font-bold text-white shadow-lg transition-all flex items-center justify-center";
                    btn.innerText = opt;
                    btn.onclick = () => this.handleAnswer(opt);
                    container.appendChild(btn);
                });
            },

            showFeedback(isSuccess) {
                const layer = document.getElementById('feedback-layer');
                const emojiDiv = document.getElementById('feedback-emoji');
                const textDiv = document.getElementById('feedback-text');

                layer.classList.remove('hidden');
                layer.classList.add('flex');

                if (isSuccess) {
                    layer.className = "absolute inset-0 z-50 flex flex-col items-center justify-center bg-emerald-600/95 backdrop-blur-sm animate-pop";
                    const emoji = this.emojis.success[Math.floor(Math.random() * this.emojis.success.length)];
                    emojiDiv.innerHTML = emoji;
                    textDiv.innerText = "BRAWO!";
                    textDiv.className = "text-5xl font-black text-white mt-4 tracking-wider";
                } else {
                    layer.className = "absolute inset-0 z-50 flex flex-col items-center justify-center bg-rose-600/95 backdrop-blur-sm animate-shake";
                    const emoji = this.emojis.error[Math.floor(Math.random() * this.emojis.error.length)];
                    emojiDiv.innerHTML = emoji;
                    textDiv.innerText = "SPR√ìBUJ JESZCZE RAZ";
                    textDiv.className = "text-2xl font-bold text-white mt-4";
                }
            },

            hideFeedback() {
                const layer = document.getElementById('feedback-layer');
                layer.classList.add('hidden');
                layer.classList.remove('flex');
            },

            updateUI() {
                document.getElementById('score-val').innerText = this.state.score;
                
                const rangeInd = document.getElementById('range-indicator');
                rangeInd.innerText = this.state.range;
                rangeInd.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs transition-colors ${this.state.range === 20 ? 'bg-purple-500' : 'bg-emerald-500'} text-white`;

                const btns = {
                    ADD: document.getElementById('btn-mode-add'),
                    SUB: document.getElementById('btn-mode-sub'),
                    COUNT: document.getElementById('btn-mode-count')
                };

                const activeClass = "bg-slate-700 text-yellow-400 shadow-inner";
                const inactiveClass = "text-slate-400 hover:text-white";

                Object.keys(btns).forEach(key => {
                    if (key === this.state.mode) {
                        btns[key].className = `flex-1 py-3 px-2 rounded-xl font-bold text-sm sm:text-lg transition-all flex items-center justify-center gap-2 whitespace-nowrap ${activeClass}`;
                    } else {
                        btns[key].className = `flex-1 py-3 px-2 rounded-xl font-bold text-sm sm:text-lg transition-all flex items-center justify-center gap-2 whitespace-nowrap ${inactiveClass}`;
                    }
                });
            }
        };

        window.onload = () => App.init();

    </script>
</body>
</html>