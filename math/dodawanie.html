<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matematyka Przedszkolaka 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Blokada zaznaczania tekstu dla UI */
        body { user-select: none; -webkit-user-select: none; touch-action: manipulation; }
        
        /* Animacje */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        @keyframes spin-slow { to { transform: rotate(360deg); } }
        .spin-slow { animation: spin-slow 4s linear infinite; }

        /* Style specyficzne dla kafelk贸w */
        .tile-btn:active { transform: scale(0.95); }
        
        /* Custom Scrollbar hide */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen flex flex-col items-center justify-center p-2 font-sans overflow-hidden">

    <!-- GWNY KONTENER -->
    <div class="w-full max-w-2xl flex flex-col gap-4 h-[95vh]">
        
        <!-- 1. PASEK GRNY (TABS & STATUS) -->
        <div class="flex flex-col gap-2">
            <!-- Zakadki -->
            <div class="bg-slate-800 p-1 rounded-2xl flex shadow-lg">
                <button onclick="App.setMode('ADD')" id="btn-mode-add" class="flex-1 py-3 rounded-xl font-bold text-lg transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> Dodawanie
                </button>
                <button onclick="App.setMode('COUNT')" id="btn-mode-count" class="flex-1 py-3 rounded-xl font-bold text-lg transition-colors flex items-center justify-center gap-2">
                    <i data-lucide="layout-grid" class="w-5 h-5"></i> Liczenie
                </button>
            </div>

            <!-- Pasek Info: Wynik | Zakres -->
            <div class="flex justify-between items-center px-2">
                <div class="flex items-center gap-3 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700">
                    <i data-lucide="star" class="w-6 h-6 text-yellow-400 fill-yellow-400"></i>
                    <span id="score-val" class="text-2xl font-bold text-white">0</span>
                </div>

                <!-- Przecznik Zakresu -->
                <button onclick="App.toggleRange()" class="flex items-center gap-2 bg-slate-800 px-1 py-1 pr-4 rounded-full border border-slate-700 active:scale-95 transition-transform">
                    <div id="range-indicator" class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs bg-emerald-500 text-white transition-colors">
                        10
                    </div>
                    <span class="text-xs font-bold text-slate-400 uppercase tracking-wide">Zakres</span>
                </button>
            </div>
        </div>

        <!-- 2. SCENA GRY (CANVAS) -->
        <div class="flex-1 bg-slate-800 rounded-3xl border border-slate-700 relative overflow-hidden flex flex-col shadow-2xl">
            
            <!-- Overlay Feedback (Brawo/Bd) -->
            <div id="feedback-layer" class="absolute inset-0 z-50 hidden flex-col items-center justify-center bg-slate-900/95 backdrop-blur-sm">
                <div id="feedback-icon" class="mb-4"></div>
                <div id="feedback-text" class="text-4xl font-bold"></div>
            </div>

            <!-- Obszar Wizualizacji -->
            <div class="flex-1 flex flex-col p-4">
                
                <!-- Kontener Klock贸w -->
                <div id="visual-container" class="flex-1 flex items-center justify-center w-full bg-slate-900/50 rounded-2xl border border-slate-700/50 p-4 mb-4">
                    <!-- Dynamiczna zawarto -->
                </div>

                <!-- Pytanie -->
                <div class="h-16 flex items-center justify-center">
                    <h2 id="question-text" class="text-2xl sm:text-3xl font-bold text-slate-300">Ile to razem?</h2>
                </div>
            </div>
        </div>

        <!-- 3. PANEL ODPOWIEDZI -->
        <div id="options-container" class="grid grid-cols-4 gap-3 h-24 sm:h-32">
            <!-- Przyciski generowane dynamicznie -->
        </div>

        <!-- Stopka: Reset -->
        <div class="flex justify-center mt-2">
            <button onclick="App.reset()" class="text-slate-500 text-sm flex items-center gap-2 hover:text-slate-300 p-2">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> Resetuj wynik
            </button>
        </div>
    </div>

    <!-- LOGIKA APLIKACJI -->
    <script>
        /**
         * LOGIC CORE - Czysta matematyka, bez DOM.
         */
        const MathCore = {
            // Generuje pytanie do dodawania
            generateAddition(range, currentScore) {
                // Progresja trudnoci dla zakresu do 10
                let maxTarget = range;
                if (range === 10) {
                    if (currentScore < 5) maxTarget = 5;       // Bardzo proste (do 5)
                    else if (currentScore < 10) maxTarget = 8; // rednie (do 8)
                    else maxTarget = 10;
                } else {
                    // Dla zakresu 20, staramy si dawa wyniki powy偶ej 10
                    maxTarget = 20;
                }

                const minTarget = range === 20 ? 11 : 2;
                
                // Losowanie sumy (wyniku)
                const target = Math.floor(Math.random() * (maxTarget - minTarget + 1)) + minTarget;
                
                // Rozbicie na skadniki A i B
                // A musi by < target, B = target - A
                const splitPoint = Math.floor(Math.random() * (target - 1)) + 1;
                let a = splitPoint;
                let b = target - splitPoint;

                // ZASADA: Preferuj A > B (80% szans) dla uatwienia liczenia
                if (b > a && Math.random() > 0.2) {
                    [a, b] = [b, a];
                }

                return {
                    type: 'ADD',
                    a: a,
                    b: b,
                    correct: target
                };
            },

            // Generuje pytanie do liczenia (Counting)
            generateCounting(range) {
                const minVal = range === 20 ? 5 : 1;
                const target = Math.floor(Math.random() * (range - minVal + 1)) + minVal;
                
                // Okrelenie ukadu (Strategy Pattern)
                let layout = 'pairs'; // domylnie pary
                if (target <= 9 && Math.random() > 0.5) layout = 'square'; // kwadraty/kostka
                if (target % 5 === 0 || (target > 10 && Math.random() > 0.6)) layout = 'fives'; // pitki

                return {
                    type: 'COUNT',
                    value: target,
                    layout: layout,
                    correct: target
                };
            },

            // Generuje odpowiedzi (jedna poprawna, 3 bdne, posortowane)
            generateOptions(correct, maxRange) {
                const options = new Set();
                options.add(correct);

                // Pula bezpiecznych bd贸w (blisko wyniku)
                const candidates = [
                    correct - 1, correct + 1, 
                    correct - 2, correct + 2, 
                    correct - 3, correct + 3
                ];

                // Mieszanie kandydat贸w
                candidates.sort(() => Math.random() - 0.5);

                for (let n of candidates) {
                    // Filtrowanie: musi by > 0, <= maxRange + zapas, i unikalne
                    if (n > 0 && n <= (maxRange + 5) && !options.has(n)) {
                        options.add(n);
                    }
                    if (options.size === 4) break;
                }

                // Jakby brakowao (rzadki edge case przy bardzo maych liczbach np. 1)
                while (options.size < 4) {
                    let r = Math.floor(Math.random() * maxRange) + 1;
                    if (r > 0) options.add(r);
                }

                return Array.from(options).sort((a, b) => a - b);
            }
        };

        /**
         * RENDERER - Funkcje pomocnicze do HTML
         */
        const Renderer = {
            // Tworzy HTML dla pojedynczego klocka
            createBlock(color, size = "md") {
                const sizes = {
                    sm: "w-5 h-5 sm:w-6 sm:h-6",
                    md: "w-8 h-8 sm:w-10 sm:h-10",
                    lg: "w-10 h-10 sm:w-12 sm:h-12"
                };
                return `<div class="${sizes[size]} bg-${color}-500 rounded-md border-2 border-slate-900 shadow-[0_4px_0_rgba(0,0,0,0.3)] transform transition-transform hover:scale-110"></div>`;
            },

            // Tworzy grid klock贸w
            createGrid(count, color, layout = 'auto') {
                let gridClass = "grid-cols-2"; // default pairs
                let size = "md";
                
                // Dostosowanie do iloci
                if (count > 12) size = "sm";

                if (layout === 'fives') gridClass = "grid-cols-5";
                else if (layout === 'square') gridClass = count > 4 ? "grid-cols-3" : "grid-cols-2";
                else if (count > 8) gridClass = "grid-cols-3 sm:grid-cols-4"; // auto adjustment

                let html = `<div class="grid ${gridClass} gap-2 p-2 bg-slate-800/50 rounded-xl border border-slate-700/50">`;
                for (let i = 0; i < count; i++) {
                    // Logic for grouping colors in 'fives' layout
                    let c = color;
                    if (layout === 'fives') {
                        // Co 5 klock贸w zmiana odcienia dla atwiejszego liczenia
                        if (Math.floor(i / 5) % 2 !== 0) c = color === 'blue' ? 'indigo' : 'emerald';
                    }
                    html += this.createBlock(c, size);
                }
                html += `</div>`;
                return html;
            }
        };

        /**
         * APP CONTROLLER - Zarzdza stanem i zdarzeniami
         */
        const App = {
            state: {
                mode: 'ADD',    // ADD | COUNT
                range: 10,      // 10 | 20
                score: 0,
                isLocked: false,
                currentQuestion: null
            },

            init() {
                lucide.createIcons();
                this.updateUI();
                this.nextQuestion();
            },

            setMode(mode) {
                if (this.state.isLocked) return;
                this.state.mode = mode;
                this.state.score = 0; // Reset wyniku przy zmianie trybu? Uznajmy 偶e tak, dla czystoci.
                this.updateUI();
                this.nextQuestion();
            },

            toggleRange() {
                if (this.state.isLocked) return;
                this.state.range = this.state.range === 10 ? 20 : 10;
                this.state.score = 0;
                this.updateUI();
                this.nextQuestion();
            },

            reset() {
                this.state.score = 0;
                this.updateUI();
                this.nextQuestion();
            },

            // G贸wna ptla gry
            nextQuestion() {
                this.state.isLocked = false;
                this.hideFeedback();

                const { mode, range, score } = this.state;
                let qData;

                // 1. Generowanie danych logicznych
                if (mode === 'ADD') {
                    qData = MathCore.generateAddition(range, score);
                } else {
                    qData = MathCore.generateCounting(range);
                }

                // 2. Generowanie opcji
                const options = MathCore.generateOptions(qData.correct, range);

                this.state.currentQuestion = { ...qData, options };
                
                // 3. Renderowanie
                this.renderScene();
                this.renderOptions();
            },

            handleAnswer(answer) {
                if (this.state.isLocked) return;
                
                const correct = this.state.currentQuestion.correct;
                this.state.isLocked = true; // BLOKADA KLIKANIA

                if (answer === correct) {
                    // SUKCES
                    this.state.score++;
                    this.updateUI(); // Odwie偶 wynik
                    this.showFeedback(true);
                    
                    // Szybkie przejcie (500ms)
                    setTimeout(() => {
                        this.nextQuestion(); 
                        // nextQuestion zdejmuje blokad isLocked
                    }, 600);
                } else {
                    // BD
                    this.showFeedback(false);
                    // Du偶sza chwila na refleksj (1200ms)
                    setTimeout(() => {
                        this.hideFeedback();
                        this.state.isLocked = false; // Zdejmij blokad, pozw贸l spr贸bowa ponownie (lub generuj nowe - tu wybieram: pozw贸l poprawi)
                        // Aby wymusi nowe pytanie po bdzie, odkomentuj: this.nextQuestion();
                        // Ale dydaktycznie lepiej pozwoli poprawi.
                    }, 1200);
                }
            },

            // --- UI MANAGERS ---

            renderScene() {
                const q = this.state.currentQuestion;
                const container = document.getElementById('visual-container');
                const title = document.getElementById('question-text');

                container.innerHTML = ''; // Clear

                if (q.type === 'ADD') {
                    title.innerText = "Ile to razem?";
                    container.innerHTML = `
                        <div class="flex items-center gap-4 animate-pop">
                            <div class="flex flex-col items-center">
                                <span class="text-4xl font-bold text-blue-400 mb-2">${q.a}</span>
                                ${Renderer.createGrid(q.a, 'blue')}
                            </div>
                            <div class="text-4xl font-black text-slate-500">+</div>
                            <div class="flex flex-col items-center">
                                <span class="text-4xl font-bold text-orange-400 mb-2">${q.b}</span>
                                ${Renderer.createGrid(q.b, 'orange')}
                            </div>
                        </div>
                    `;
                } else {
                    title.innerText = "Ile klock贸w widzisz?";
                    // Use layout from logic, fallback to auto if undefined
                    // Kolor zielony dla liczenia
                    container.innerHTML = `
                        <div class="flex flex-col items-center animate-pop">
                            ${Renderer.createGrid(q.value, 'green', q.layout)}
                        </div>
                    `;
                }
            },

            renderOptions() {
                const container = document.getElementById('options-container');
                container.innerHTML = '';

                this.state.currentQuestion.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "tile-btn bg-slate-700 hover:bg-slate-600 border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 rounded-2xl text-3xl sm:text-4xl font-bold text-white shadow-lg transition-all flex items-center justify-center";
                    btn.innerText = opt;
                    btn.onclick = () => this.handleAnswer(opt);
                    container.appendChild(btn);
                });
            },

            showFeedback(isSuccess) {
                const layer = document.getElementById('feedback-layer');
                const icon = document.getElementById('feedback-icon');
                const text = document.getElementById('feedback-text');

                layer.classList.remove('hidden');
                layer.classList.add('flex');

                if (isSuccess) {
                    layer.className = "absolute inset-0 z-50 flex flex-col items-center justify-center bg-emerald-600/95 backdrop-blur-sm animate-pop";
                    icon.innerHTML = `<i data-lucide="star" class="w-32 h-32 text-white fill-white spin-slow"></i>`;
                    text.innerText = "BRAWO!";
                    text.className = "text-5xl font-black text-white mt-4 tracking-wider";
                } else {
                    layer.className = "absolute inset-0 z-50 flex flex-col items-center justify-center bg-rose-600/95 backdrop-blur-sm animate-pop";
                    icon.innerHTML = `<span class="text-8xl"></span>`;
                    text.innerText = "SPRBUJ JESZCZE RAZ";
                    text.className = "text-2xl font-bold text-white mt-4";
                }
                lucide.createIcons();
            },

            hideFeedback() {
                const layer = document.getElementById('feedback-layer');
                layer.classList.add('hidden');
                layer.classList.remove('flex');
            },

            updateUI() {
                // Score
                document.getElementById('score-val').innerText = this.state.score;
                
                // Range Indicator
                const rangeInd = document.getElementById('range-indicator');
                rangeInd.innerText = this.state.range;
                rangeInd.className = `w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs transition-colors ${this.state.range === 20 ? 'bg-purple-500' : 'bg-emerald-500'} text-white`;

                // Tabs Styling
                const btnAdd = document.getElementById('btn-mode-add');
                const btnCount = document.getElementById('btn-mode-count');
                const activeClass = "bg-slate-700 text-yellow-400 shadow-inner";
                const inactiveClass = "text-slate-400 hover:text-white";

                if (this.state.mode === 'ADD') {
                    btnAdd.className = `flex-1 py-3 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${activeClass}`;
                    btnCount.className = `flex-1 py-3 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${inactiveClass}`;
                } else {
                    btnAdd.className = `flex-1 py-3 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${inactiveClass}`;
                    btnCount.className = `flex-1 py-3 rounded-xl font-bold text-lg transition-all flex items-center justify-center gap-2 ${activeClass}`;
                }
            }
        };

        // Start aplikacji po zaadowaniu
        window.onload = () => App.init();

    </script>
</body>
</html>