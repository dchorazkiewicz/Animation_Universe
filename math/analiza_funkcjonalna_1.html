<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiza Funkcjonalna: Bazy Ortogonalne</title>
    
    <!-- Fonty -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>

    <!-- MathJax do renderowania LaTeX -->
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { background-color: #020617; color: #e2e8f0; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Canvas Styles */
        canvas { 
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Sekcja aktywna w teorii */
        .highlight-section {
            border-left: 4px solid #3b82f6;
            background: rgba(59, 130, 246, 0.05);
            transition: all 0.3s ease;
        }
        
        .math-block { margin: 1rem 0; overflow-x: auto; }
        
        /* Lista wielomianów */
        .poly-list li {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            color: #94a3b8;
            padding: 2px 0;
        }
        .poly-list li strong { color: #e2e8f0; }

        /* Tabs */
        .tab-btn.active {
            background-color: #2563eb;
            color: white;
        }
        .tab-btn {
            background-color: transparent;
            color: #94a3b8;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0 z-50 shadow-md">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold font-mono">∫</div>
            <h1 class="font-semibold text-lg tracking-tight">Analiza Funkcjonalna <span class="text-slate-500 font-normal">| Bazy Ortogonalne w $L^2$</span></h1>
        </div>
        <div class="text-xs text-slate-400 font-mono hidden md:block">
            $f(x) \approx \sum c_n \phi_n(x)$
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- LEWY PANEL: TEORIA (Scrollable) -->
        <aside id="theory-panel" class="w-full md:w-[500px] lg:w-[600px] bg-slate-900 border-r border-slate-800 flex flex-col z-20 shrink-0 shadow-xl">
            
            <!-- Tab Header -->
            <div class="p-6 pb-0 bg-slate-900 sticky top-0 z-30">
                <h2 class="text-2xl font-bold text-white mb-4">Teoria Przestrzeni</h2>
                
                <div class="flex p-1 bg-slate-950 rounded-lg mb-4 border border-slate-800">
                    <button onclick="switchTab('summary')" id="tab-summary" class="tab-btn active flex-1 py-1.5 text-xs font-medium rounded-md transition-all">Przegląd Baz</button>
                    <button onclick="switchTab('deep')" id="tab-deep" class="tab-btn flex-1 py-1.5 text-xs font-medium rounded-md transition-all">Szczegóły Matematyczne</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-6 pt-0 text-sm leading-relaxed text-slate-300">
                
                <!-- TAB 1: PRZEGLĄD (Podstawy) -->
                <div id="content-summary">
                    <section id="theory-intro" class="mb-8 pb-6 border-b border-slate-800">
                        <p class="mb-4 text-slate-400">
                            W przestrzeni Hilberta $L^2$ funkcje traktujemy jak wektory. Kluczem jest iloczyn skalarny z wagą $w(x)$, który definiuje geometrię (kąty, długości):
                        </p>
                        <div class="math-block bg-slate-950 p-3 rounded border border-slate-800">
                            $$ \langle f, g \rangle_w = \int_a^b f(x) g(x) w(x) \, dx $$
                        </div>
                    </section>

                    <div class="space-y-4">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Bazy Dostępne</h3>

                        <section id="summary-legendre" class="theory-item p-4 rounded-lg hover:bg-slate-800/50 transition border border-transparent hover:border-slate-700">
                            <h4 class="text-lg font-bold text-slate-100 flex items-center gap-2 mb-2">
                                <span class="w-2 h-2 rounded-full bg-blue-500"></span> Legendre ($P_n$)
                            </h4>
                            <p class="text-slate-400 mb-2">Baza na odcinku $[-1, 1]$ z wagą $w(x)=1$.</p>
                            <div class="bg-slate-950 p-3 rounded border border-slate-800 mb-2">
                                <ul class="poly-list">
                                    <li><strong>P₀</strong> = 1</li>
                                    <li><strong>P₁</strong> = x</li>
                                    <li><strong>P₂</strong> = $\frac{1}{2}(3x^2 - 1)$</li>
                                    <li><strong>P₃</strong> = $\frac{1}{2}(5x^3 - 3x)$</li>
                                </ul>
                            </div>
                        </section>

                        <section id="summary-chebyshev" class="theory-item p-4 rounded-lg hover:bg-slate-800/50 transition border border-transparent hover:border-slate-700">
                            <h4 class="text-lg font-bold text-slate-100 flex items-center gap-2 mb-2">
                                <span class="w-2 h-2 rounded-full bg-purple-500"></span> Czebyszew ($T_n$)
                            </h4>
                            <p class="text-slate-400 mb-2">Waga $w(x) = (1-x^2)^{-1/2}$. Minimalizują błąd maksymalny.</p>
                            <div class="bg-slate-950 p-3 rounded border border-slate-800 mb-2">
                                <ul class="poly-list">
                                    <li><strong>T₀</strong> = 1</li>
                                    <li><strong>T₁</strong> = x</li>
                                    <li><strong>T₂</strong> = $2x^2 - 1$</li>
                                    <li><strong>T₃</strong> = $4x^3 - 3x$</li>
                                </ul>
                            </div>
                        </section>

                        <section id="summary-hermite" class="theory-item p-4 rounded-lg hover:bg-slate-800/50 transition border border-transparent hover:border-slate-700">
                            <h4 class="text-lg font-bold text-slate-100 flex items-center gap-2 mb-2">
                                <span class="w-2 h-2 rounded-full bg-red-500"></span> Hermite ($H_n$)
                            </h4>
                            <p class="text-slate-400 mb-2">Dla prostej $(-\infty, \infty)$. Waga gaussowska $e^{-x^2}$.</p>
                            <div class="bg-slate-950 p-3 rounded border border-slate-800 mb-2">
                                <ul class="poly-list">
                                    <li><strong>H₀</strong> = 1</li>
                                    <li><strong>H₁</strong> = $2x$</li>
                                    <li><strong>H₂</strong> = $4x^2 - 2$</li>
                                    <li><strong>H₃</strong> = $8x^3 - 12x$</li>
                                </ul>
                            </div>
                        </section>

                        <section id="summary-fourier" class="theory-item p-4 rounded-lg hover:bg-slate-800/50 transition border border-transparent hover:border-slate-700">
                            <h4 class="text-lg font-bold text-slate-100 flex items-center gap-2 mb-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span> Fourier
                            </h4>
                            <p class="text-slate-400 mb-2">Baza trygonometryczna $\{1, \sin(nx), \cos(nx)\}$.</p>
                        </section>
                    </div>
                </div>

                <!-- TAB 2: SZCZEGÓŁY (Deep Math) -->
                <div id="content-deep" class="hidden space-y-8">
                    
                    <div class="text-slate-400 mb-6 italic">
                        Tutaj opisujemy genezę tych funkcji. Większość z nich to rozwiązania problemów własnych operatorów różniczkowych (teoria Sturma-Liouville'a) lub wynik ortogonalizacji Grama-Schmidta.
                    </div>

                    <!-- Legendre Deep -->
                    <section id="deep-legendre" class="theory-item border-l-2 border-blue-500 pl-4 py-2">
                        <h3 class="text-xl font-bold text-blue-400 mb-3">Wielomiany Legendre'a</h3>
                        
                        <p class="mb-2 font-bold text-slate-200">Geneza:</p>
                        <p class="mb-2">Rozwiązanie równania różniczkowego Legendre'a, które pojawia się przy rozwiązywaniu równania Laplace'a we współrzędnych sferycznych (np. potencjał w elektrostatyce).</p>
                        <div class="math-block text-xs bg-slate-950 p-2 rounded">
                            $$ (1-x^2)y'' - 2xy' + n(n+1)y = 0 $$
                        </div>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Wzór Rodriguesa (Generator):</p>
                        <p class="mb-2">Pozwala wygenerować dowolny wielomian $P_n$ poprzez różniczkowanie:</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ P_n(x) = \frac{1}{2^n n!} \frac{d^n}{dx^n} [(x^2 - 1)^n] $$
                        </div>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Warunek Ortogonalności:</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ \int_{-1}^{1} P_n(x) P_m(x) \, dx = \frac{2}{2n+1} \delta_{nm} $$
                        </div>
                    </section>

                    <!-- Chebyshev Deep -->
                    <section id="deep-chebyshev" class="theory-item border-l-2 border-purple-500 pl-4 py-2">
                        <h3 class="text-xl font-bold text-purple-400 mb-3">Wielomiany Czebyszewa (I Rodzaju)</h3>
                        
                        <p class="mb-2 font-bold text-slate-200">Geneza:</p>
                        <p class="mb-2">Wynikają z rzutowania wielomianów na okrąg jednostkowy. Definicja trygonometryczna:</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ T_n(x) = \cos(n \arccos x) $$
                        </div>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Równanie Różniczkowe:</p>
                        <div class="math-block text-xs bg-slate-950 p-2 rounded">
                            $$ (1-x^2)y'' - xy' + n^2y = 0 $$
                        </div>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Warunek Ortogonalności (Waga Singularna):</p>
                        <p class="mb-2">Waga $\frac{1}{\sqrt{1-x^2}}$ sprawia, że błędy są "karane" bardziej na brzegach przedziału, co wyrównuje błąd aproksymacji na całym odcinku.</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ \int_{-1}^{1} T_n(x) T_m(x) \frac{1}{\sqrt{1-x^2}} \, dx = \begin{cases} \pi & n=m=0 \\ \pi/2 & n=m \neq 0 \\ 0 & n \neq m \end{cases} $$
                        </div>
                    </section>

                    <!-- Hermite Deep -->
                    <section id="deep-hermite" class="theory-item border-l-2 border-red-500 pl-4 py-2">
                        <h3 class="text-xl font-bold text-red-400 mb-3">Wielomiany Hermite'a (Fizyczne)</h3>
                        
                        <p class="mb-2 font-bold text-slate-200">Geneza:</p>
                        <p class="mb-2">Fundamentalne w mechanice kwantowej. Funkcje falowe kwantowego oscylatora harmonicznego to wielomiany Hermite'a pomnożone przez funkcję Gaussa.</p>
                        <div class="math-block text-xs bg-slate-950 p-2 rounded">
                            $$ y'' - 2xy' + 2ny = 0 $$
                        </div>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Wzór Rodriguesa:</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ H_n(x) = (-1)^n e^{x^2} \frac{d^n}{dx^n} e^{-x^2} $$
                        </div>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Warunek Ortogonalności:</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ \int_{-\infty}^{\infty} H_n(x) H_m(x) e^{-x^2} \, dx = \sqrt{\pi} 2^n n! \delta_{nm} $$
                        </div>
                    </section>

                    <!-- Fourier Deep -->
                    <section id="deep-fourier" class="theory-item border-l-2 border-green-500 pl-4 py-2">
                        <h3 class="text-xl font-bold text-green-400 mb-3">Szereg Fouriera</h3>
                        
                        <p class="mb-2 font-bold text-slate-200">Geneza:</p>
                        <p class="mb-2">Problem własny operatora drugiej pochodnej $y'' = \lambda y$ z warunkami okresowymi $y(-\pi) = y(\pi)$.</p>

                        <p class="mb-2 mt-4 font-bold text-slate-200">Ortogonalność:</p>
                        <p class="mb-2">Funkcje $\sin$ i $\cos$ są wzajemnie prostopadłe na pełnym okresie:</p>
                        <div class="math-block text-xs bg-slate-950 p-2 rounded">
                            $$ \int_{-\pi}^{\pi} \cos(nx)\cos(mx)\,dx = \pi \delta_{nm} $$
                            $$ \int_{-\pi}^{\pi} \sin(nx)\cos(mx)\,dx = 0 $$
                        </div>
                        
                        <p class="mb-2 mt-4 font-bold text-slate-200">Tożsamość Parsevala:</p>
                        <p class="mb-2 text-xs">Energia sygnału (norma $L^2$) jest równa sumie kwadratów współczynników Fouriera.</p>
                        <div class="math-block bg-slate-950 p-2 rounded">
                            $$ \frac{1}{\pi} \int_{-\pi}^{\pi} |f(x)|^2 dx = \frac{a_0^2}{2} + \sum_{n=1}^{\infty} (a_n^2 + b_n^2) $$
                        </div>
                    </section>
                </div>

            </div>
            
            <div class="h-10"></div>
        </aside>

        <!-- PRAWY PANEL: LABORATORIUM -->
        <main class="flex-1 flex flex-col bg-slate-950 relative min-w-0">
            
            <!-- Controls Bar -->
            <div class="h-16 border-b border-slate-800 bg-slate-900/50 backdrop-blur-md flex items-center px-4 gap-4 overflow-x-auto shrink-0">
                
                <!-- Function Selector -->
                <div class="flex items-center gap-2 shrink-0">
                    <span class="text-xs text-slate-500 font-bold uppercase">Funkcja:</span>
                    <select id="func-select" class="bg-slate-800 text-sm text-white border border-slate-700 rounded px-2 py-1 outline-none focus:border-blue-500">
                        <option value="runge">Efekt Rungego (1/(1+25x²))</option>
                        <option value="abs">Moduł |x|</option>
                        <option value="step">Skok (Heaviside)</option>
                        <option value="poly">Wielomian x³-x</option>
                        <option value="sin">Sinusoida złożona</option>
                        <option value="gauss">Gauss e^(-x²)</option>
                    </select>
                </div>

                <div class="w-px h-6 bg-slate-700 shrink-0"></div>

                <!-- Basis Selector -->
                <div class="flex items-center gap-2 shrink-0">
                    <span class="text-xs text-slate-500 font-bold uppercase">Baza Ortogonalna:</span>
                    <div class="flex bg-slate-800 p-1 rounded-lg">
                        <button onclick="setBasis('legendre')" id="btn-legendre" class="basis-btn px-3 py-1 rounded text-xs font-medium transition bg-blue-600 text-white shadow">Legendre</button>
                        <button onclick="setBasis('chebyshev')" id="btn-chebyshev" class="basis-btn px-3 py-1 rounded text-xs font-medium transition text-slate-400 hover:text-white">Czebyszew</button>
                        <button onclick="setBasis('hermite')" id="btn-hermite" class="basis-btn px-3 py-1 rounded text-xs font-medium transition text-slate-400 hover:text-white">Hermite</button>
                        <button onclick="setBasis('fourier')" id="btn-fourier" class="basis-btn px-3 py-1 rounded text-xs font-medium transition text-slate-400 hover:text-white">Fourier</button>
                    </div>
                </div>

                <div class="w-px h-6 bg-slate-700 shrink-0"></div>

                <!-- Slider -->
                <div class="flex items-center gap-3 shrink-0 flex-1 min-w-[150px]">
                    <span class="text-xs text-slate-500 font-bold uppercase whitespace-nowrap">Rząd N: <span id="n-display" class="text-blue-400 text-sm">5</span></span>
                    <input type="range" id="n-slider" min="0" max="40" value="5" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                </div>
            </div>

            <!-- Canvas Container -->
            <div class="flex-1 relative w-full h-full overflow-hidden">
                <canvas id="mainCanvas" class="block w-full h-full"></canvas>

                <!-- Checkboxes Overlay -->
                <div class="absolute bottom-6 right-6 flex flex-col gap-2 bg-slate-900/80 backdrop-blur border border-slate-700 p-3 rounded-lg shadow-2xl text-xs z-10">
                    <label class="flex items-center gap-2 cursor-pointer text-slate-300 hover:text-white">
                        <input type="checkbox" id="chk-orig" checked class="accent-slate-500">
                        <span class="w-3 h-3 rounded-full border border-white bg-transparent"></span>
                        Oryginał f(x)
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-slate-300 hover:text-white">
                        <input type="checkbox" id="chk-approx" checked class="accent-yellow-500">
                        <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                        Suma Aproksymacyjna
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer text-slate-300 hover:text-white">
                        <input type="checkbox" id="chk-basis" class="accent-blue-500">
                        <span class="w-3 h-3 rounded-full bg-blue-500/50"></span>
                        Składowe Bazowe
                    </label>
                </div>

                <!-- Error Display -->
                <div class="absolute top-6 left-6 pointer-events-none">
                    <div class="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-2 rounded-lg backdrop-blur-sm shadow-lg">
                        <div class="text-[10px] uppercase tracking-wider font-bold opacity-70">Błąd średniokwadratowy</div>
                        <div class="text-xl font-mono font-bold" id="error-val">0.0000</div>
                    </div>
                </div>
                
            </div>
        </main>
    </div>

<script>
    // --- KONFIGURACJA ---
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d');
    
    const state = {
        funcId: 'runge',
        basisId: 'legendre',
        activeTab: 'summary',
        N: 5,
        showOriginal: true,
        showApprox: true,
        showBasis: false
    };

    // Definicje funkcji f(x)
    const functions = {
        'runge': x => 1 / (1 + 25 * x * x),
        'abs': x => Math.abs(x),
        'step': x => x >= 0 ? 0.8 : -0.8,
        'poly': x => 0.5 * (x * x * x - 3*x), 
        'sin': x => Math.sin(Math.PI * x) + 0.5 * Math.cos(3 * Math.PI * x),
        'gauss': x => Math.exp(-x*x * 2) 
    };

    // --- MATEMATYKA BAZOWA (BEZ TAYLORA) ---

    // 1. Legendre (Rekurencja)
    function legendreP(n, x) {
        if (n === 0) return 1;
        if (n === 1) return x;
        let p0 = 1, p1 = x;
        for (let i = 2; i <= n; i++) {
            let p2 = ((2 * i - 1) * x * p1 - (i - 1) * p0) / i;
            p0 = p1; p1 = p2;
        }
        return p1;
    }

    // 2. Czebyszew I (Rekurencja)
    function chebyshevT(n, x) {
        if (n === 0) return 1;
        if (n === 1) return x;
        let t0 = 1, t1 = x;
        for (let i = 2; i <= n; i++) {
            let t2 = 2 * x * t1 - t0;
            t0 = t1; t1 = t2;
        }
        return t1;
    }

    // 3. Hermite (Fizyczne, Rekurencja)
    function hermiteH(n, x) {
        if (n === 0) return 1;
        if (n === 1) return 2 * x;
        let h0 = 1, h1 = 2 * x;
        for (let i = 2; i <= n; i++) {
            let h2 = 2 * x * h1 - 2 * (i - 1) * h0;
            h0 = h1; h1 = h2;
        }
        // Brak silnej normalizacji, by zachować fizyczny kształt, 
        // ale w aplikacji wizualizacja może wymagać przeskalowania dla dużych N.
        return h1; 
    }

    // 4. Fourier
    function fourierBasis(n, x) {
        if (n === 0) return 1 / Math.sqrt(2); 
        const k = Math.ceil(n / 2);
        return (n % 2 === 1) ? Math.sin(k * Math.PI * x) : Math.cos(k * Math.PI * x);
    }

    // --- SILNIK NUMERYCZNY ---
    
    const INTEGRAL_STEPS = 800;
    let coefficients = [];

    function integrate(func, weight, basisN, min, max) {
        let sum = 0;
        const dx = (max - min) / INTEGRAL_STEPS;
        for(let i=0; i<INTEGRAL_STEPS; i++) {
            const x = min + (i + 0.5) * dx;
            const w = weight ? weight(x) : 1;
            sum += func(x) * basisN(x) * w * dx;
        }
        return sum;
    }

    function calcCoeffs() {
        coefficients = [];
        const f = functions[state.funcId];
        
        let basisFn, weightFn, min, max;

        // Ustawienia dla różnych baz
        if (state.basisId === 'legendre') {
            basisFn = legendreP;
            weightFn = null;
            min = -1; max = 1;
        } else if (state.basisId === 'chebyshev') {
            basisFn = chebyshevT;
            // Trick numeryczny: ucinamy w 0.999 bo waga dąży do inf
            weightFn = x => 1 / Math.sqrt(1 - Math.min(x*x, 0.9999));
            min = -1; max = 1;
        } else if (state.basisId === 'hermite') {
            basisFn = hermiteH;
            weightFn = x => Math.exp(-x*x);
            min = -4; max = 4; // Szeroki zakres dla Hermite
        } else if (state.basisId === 'fourier') {
            basisFn = fourierBasis;
            weightFn = null;
            min = -1; max = 1;
        }

        for(let n=0; n<=state.N; n++) {
            // Licznik: <f, phi>
            const num = integrate(f, weightFn, x => basisFn(n, x), min, max);
            // Mianownik: ||phi||^2
            const den = integrate((x)=>1, weightFn, x => { const v = basisFn(n, x); return v*v; }, min, max);
            
            coefficients.push(Math.abs(den) > 1e-9 ? num/den : 0);
        }
    }

    function getApprox(x) {
        let val = 0;
        for(let n=0; n<=state.N; n++) {
            let phi = 0;
            if (state.basisId === 'legendre') phi = legendreP(n, x);
            else if (state.basisId === 'chebyshev') phi = chebyshevT(n, x);
            else if (state.basisId === 'hermite') phi = hermiteH(n, x);
            else if (state.basisId === 'fourier') phi = fourierBasis(n, x);
            val += coefficients[n] * phi;
        }
        return val;
    }

    // --- RENDEROWANIE ---

    function draw() {
        const rect = canvas.parentNode.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        const w = canvas.width, h = canvas.height;

        ctx.clearRect(0, 0, w, h);

        const domainX = state.basisId === 'hermite' ? 4.0 : 1.5;
        const scaleX = w / (2 * domainX); 
        const scaleY = h / 3.0; 
        const midX = w / 2;
        const midY = h / 2;

        const toScrx = x => midX + x * scaleX;
        const toScry = y => midY - y * scaleY;

        // Siatka i Osie
        ctx.lineWidth = 1;
        ctx.strokeStyle = '#334155';
        ctx.beginPath(); ctx.moveTo(0, midY); ctx.lineTo(w, midY); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(midX, 0); ctx.lineTo(midX, h); ctx.stroke();

        if (state.basisId !== 'hermite') {
            ctx.strokeStyle = '#475569';
            ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(toScrx(-1), 0); ctx.lineTo(toScrx(-1), h); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(toScrx(1), 0); ctx.lineTo(toScrx(1), h); ctx.stroke();
            ctx.setLineDash([]);
        }

        const func = functions[state.funcId];
        let errorSum = 0;
        let count = 0;

        if (state.showBasis) {
            ctx.lineWidth = 1;
            ctx.globalAlpha = 0.3;
            for(let n=0; n<=state.N; n++) {
                if (Math.abs(coefficients[n]) < 0.01) continue;
                ctx.strokeStyle = n%2 ? '#60a5fa' : '#f87171';
                ctx.beginPath();
                for(let ix=0; ix<=w; ix+=2) {
                    const x = (ix - midX) / scaleX;
                    if (state.basisId !== 'hermite' && Math.abs(x) > 1) continue;
                    
                    let phi = 0;
                    if (state.basisId === 'legendre') phi = legendreP(n, x);
                    else if (state.basisId === 'chebyshev') phi = chebyshevT(n, x);
                    else if (state.basisId === 'hermite') phi = hermiteH(n, x);
                    else if (state.basisId === 'fourier') phi = fourierBasis(n, x);

                    const y = coefficients[n] * phi;
                    if (ix===0) ctx.moveTo(ix, toScry(y)); else ctx.lineTo(ix, toScry(y));
                }
                ctx.stroke();
            }
            ctx.globalAlpha = 1.0;
        }

        if (state.showOriginal) {
            ctx.strokeStyle = '#94a3b8'; 
            ctx.lineWidth = 3;
            ctx.beginPath();
            for(let ix=0; ix<=w; ix++) {
                const x = (ix - midX) / scaleX;
                const y = func(x);
                if (ix===0) ctx.moveTo(ix, toScry(y)); else ctx.lineTo(ix, toScry(y));
            }
            ctx.stroke();
        }

        if (state.showApprox) {
            ctx.strokeStyle = '#eab308'; 
            ctx.lineWidth = 2;
            ctx.shadowColor = 'rgba(234, 179, 8, 0.5)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            
            let started = false;
            for(let ix=0; ix<=w; ix++) {
                const x = (ix - midX) / scaleX;
                
                if (state.basisId !== 'hermite' && Math.abs(x) > 1) {
                    started = false; continue;
                }

                const y = getApprox(x);
                
                const inDomain = (state.basisId === 'hermite') ? Math.abs(x) < 3 : Math.abs(x) <= 1;
                if (inDomain) {
                    const trueY = func(x);
                    errorSum += (trueY - y)**2;
                    count++;
                }

                if (!started) { ctx.moveTo(ix, toScry(y)); started=true; }
                else ctx.lineTo(ix, toScry(y));
            }
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        const rmse = count > 0 ? Math.sqrt(errorSum / count) : 0;
        document.getElementById('error-val').innerText = rmse.toFixed(4);
    }

    // --- UI LOGIC ---

    // Obsługa zakładek
    window.switchTab = (tabId) => {
        state.activeTab = tabId;
        
        // UI przycisków
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tabId}`).classList.add('active');

        // Widoczność treści
        document.getElementById('content-summary').classList.add('hidden');
        document.getElementById('content-deep').classList.add('hidden');
        document.getElementById(`content-${tabId}`).classList.remove('hidden');

        // Przewiń do aktywnej bazy w nowej zakładce
        scrollToTheory(state.basisId, tabId);
    };

    function scrollToTheory(basisId, tabId) {
        // Usuń stare podświetlenia
        document.querySelectorAll('.highlight-section').forEach(el => el.classList.remove('highlight-section'));
        
        // Zbuduj ID elementu docelowego np. "summary-legendre" lub "deep-legendre"
        const targetId = `${tabId}-${basisId}`;
        const section = document.getElementById(targetId);
        
        if (section) {
            // Małe opóźnienie bo display:hidden może psuć scrollowanie
            setTimeout(() => {
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                section.classList.add('highlight-section');
            }, 10);
        }
    }

    window.setBasis = (id) => {
        state.basisId = id;
        
        // Update Buttons Styling
        document.querySelectorAll('.basis-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'shadow');
            btn.classList.add('text-slate-400', 'hover:text-white');
        });
        const activeBtn = document.getElementById(`btn-${id}`);
        activeBtn.classList.remove('text-slate-400', 'hover:text-white');
        activeBtn.classList.add('bg-blue-600', 'text-white', 'shadow');

        // Scroll Logic w aktywnej zakładce
        scrollToTheory(id, state.activeTab);

        calcCoeffs();
        draw();
    };

    document.getElementById('func-select').addEventListener('change', (e) => {
        state.funcId = e.target.value;
        calcCoeffs();
        draw();
    });

    document.getElementById('n-slider').addEventListener('input', (e) => {
        state.N = parseInt(e.target.value);
        document.getElementById('n-display').innerText = state.N;
        calcCoeffs();
        draw();
    });

    ['chk-orig', 'chk-approx', 'chk-basis'].forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
            if (id === 'chk-orig') state.showOriginal = e.target.checked;
            if (id === 'chk-approx') state.showApprox = e.target.checked;
            if (id === 'chk-basis') state.showBasis = e.target.checked;
            draw();
        });
    });

    window.addEventListener('resize', draw);

    // Init
    calcCoeffs();
    setTimeout(() => {
        draw();
        if (window.MathJax) MathJax.typesetPromise();
    }, 100);

</script>
</body>
</html>